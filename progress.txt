# Calibre Librarian MCP - Progress

## Completed Tasks

### 2026-01-20: Add testing infrastructure (Phase 4)
- Added Vitest as test framework
- Created `vitest.config.ts` for Node environment
- Added `src/utils/cache.test.ts` - 20 tests for cache utility
- Added `src/utils/pagination.test.ts` - 21 tests for pagination utility
- Added `src/utils/response.test.ts` - 20 tests for response formatting
- Updated README with test commands
- Total: 61 unit tests covering core utilities
- Commit: d3b4fc0

### 2026-01-20: Add caching layer for MCP performance (Phase 4)
- Created `src/utils/cache.ts` with TTL-based in-memory cache
- Updated calibredb.ts with optional caching support
- Added 60s cache to `get_library_stats` and `get_all_tags` queries
- Cache invalidation on write operations (set_metadata, set_custom_column, bulk_retag, normalize_author_sort)
- Reduces redundant calibredb process spawns for frequently accessed data
- Commit: acb1655

### 2026-01-20: Add Docker support (Phase 4)
- Created multi-stage `Dockerfile` with Node.js 24 and Calibre CLI
- Created `.dockerignore` to exclude dev files from build
- Created `docker-compose.yml` for easy local development
- Updated README with Docker setup instructions
- Read-only library mounts by default for safety
- Commit: 7476141

### 2026-01-20: Enhance README with full documentation (Phase 4)
- Comprehensive README.md rewrite
- Full tool catalog with example calls for all 25+ tools
- Environment variables reference table
- Resources section with URIs
- Troubleshooting guide covering common issues
- MCP Inspector testing instructions
- Commit: 3b5a4f5

### 2026-01-19: Add MCP Inspector verification guide (Phase 4)
- Created `src/resources/inspectorGuide.ts`
- Resource at calibre://docs/inspector-guide
- MCP Inspector installation and usage instructions
- Step-by-step verification with example tool calls
- Complete tool/resource/prompt checklists
- Troubleshooting section and success criteria
- Commit: 198e692

### 2026-01-19: Implement generate_claude_config tool (Phase 4)
- Created `src/tools/generate-claude-config.ts`
- Outputs JSON config for claude_desktop_config.json
- Detects config file path for macOS/Windows/Linux
- Auto-detects calibredb path per platform
- Step-by-step setup instructions and troubleshooting
- Commit: dff9b04

### 2026-01-19: Implement missing_book_scout tool (Phase 3)
- Created `src/tools/missing-book-scout.ts`
- Parses reading list ("Title" or "Title by Author" format)
- Fuzzy title matching by default
- Reports found vs missing books with match details
- Generates search URLs for missing titles
- Multiple search engines: Anna's Archive, Goodreads, Amazon, LibGen
- Commit: 94139b0

### 2026-01-19: Implement library_maintenance tool (Phase 3)
- Created `src/tools/library-maintenance.ts`
- Four operations: check, backup_metadata, embed_metadata, vacuum
- Extended timeouts for long-running operations
- Requires write flag for modifying operations
- Helpful follow-up suggestions after each operation
- Commit: 8bfaf1a

### 2026-01-19: Implement bulk_retag tool (Phase 3)
- Created `src/tools/bulk-retag.ts`
- Three actions: add, remove, replace tags
- Replace supports old_tag:new_tag format
- Preview mode by default for safety
- Uses Calibre search query to target books
- Commit: 56fbc17

### 2026-01-19: Implement normalize_author_sort tool (Phase 3)
- Created `src/tools/normalize-author-sort.ts`
- Generates expected author_sort format (LastName, FirstName)
- Handles multiple authors and suffixes (Jr., III)
- Preview mode by default for safety
- Optional author ID filter for targeted fixes
- Commit: bb3f287

### 2026-01-19: Implement quality_report tool (Phase 3)
- Created `src/tools/quality-report.ts`
- 8 quality checks: missing cover, tags, description, series, identifiers, publisher, rating, single format
- Summary table with counts and percentages
- Detailed lists per category with actionable recommendations
- Optional check selection
- Commit: ed9403e

### 2026-01-19: Add merge_duplicates prompt (Phase 3)
- Created `src/prompts/merge-duplicates.ts`
- Guided workflow: identify, compare, prepare, update, confirm
- Optional bookIds and keepId parameters
- Safety guidelines requiring explicit confirmation
- References available tools for each step
- Commit: 7f11e3a

### 2026-01-19: Implement compare_books tool (Phase 3)
- Created `src/tools/compare-books.ts`
- Compare 2-5 books side-by-side in table format
- Highlights matching vs differing fields
- Optional field selection
- Recommendations for handling differences
- Commit: 8fe3bf5

### 2026-01-19: Implement find_duplicates tool (Phase 3)
- Created `src/tools/find-duplicates.ts`
- Three modes: title, author_title, identifier
- Configurable similarity threshold (0-1)
- Can check specific book or scan entire library
- Groups duplicates with reason for flagging
- Commit: 2ace854

### 2026-01-19: Add feature flag for write operations (Phase 3)
- Added CALIBRE_ENABLE_WRITE_OPERATIONS env var to config.ts
- Default: false (disabled for safety)
- assertWriteEnabled() check in set_metadata and set_custom_column
- Updated .env.example with documentation
- Commit: a8fb13a

### 2026-01-19: Implement set_metadata tool (Phase 3)
- Created `src/tools/set-metadata.ts`
- Supports title, authors, tags, series, publisher, rating, comments, languages
- Marked as destructive (destructiveHint: true)
- Only updates specified fields, preserves others
- Reports summary of changes applied
- Commit: 3dffff3

### 2026-01-19: Implement set_custom_column tool (Phase 3)
- Created `src/tools/set-custom-column.ts`
- Marked as destructive (destructiveHint: true)
- Verifies book exists before update
- Supports append mode for multi-value columns
- Reads back value to confirm change
- Commit: 6f87e62

### 2026-01-19: Implement get_custom_columns tool (Phase 3)
- Created `src/tools/get-custom-columns.ts`
- Lists all custom columns with name, label, data type
- Optional detailed view with display settings
- Includes usage hints for searching custom columns
- Commit: e9b3dc4

### 2026-01-19: Add pagination utilities (Phase 2)
- Created `src/utils/pagination.ts`
- paginationSchema for reusable limit/offset parameters
- paginate() helper with PaginationMeta (hasMore, nextOffset)
- formatPaginationInfo() for human-readable output
- getCalibredbLimit() for calibredb integration
- Commit: 39a3011

### 2026-01-19: Add response formatting utility (Phase 2)
- Created `src/utils/response.ts`
- ToolResponse interface with success/data/error/summary fields
- formatSuccess/formatError for uniform responses
- formatBookList/formatAuthorList/formatTagList helpers
- parseCalibreBookList for parsing --for-machine JSON
- Returns both JSON block and human-readable summary
- Commit: cbc41d3

### 2026-01-19: Implement search_book_content tool (Phase 2)
- Created `src/tools/search-book-content.ts`
- Plain-text fallback when Calibre FTS unavailable
- Extracts book to text via ebook-convert
- Case-insensitive search with configurable context
- Returns matches with surrounding text snippets
- Commit: f379743

### 2026-01-19: Implement fetch_excerpt tool (Phase 2)
- Created `src/tools/fetch-excerpt.ts`
- Uses ebook-convert for format conversion to text
- Configurable max characters (default 2000, max 10000)
- Prefers text-friendly formats (EPUB, TXT, MOBI)
- Truncates at sentence/paragraph boundaries
- Commit: 25c0e34

### 2026-01-19: Implement full_text_search tool (Phase 2)
- Created `src/tools/full-text-search.ts`
- Uses Calibre's `fts_search` command
- Optional match-all mode for AND queries
- Includes text snippets showing match context
- Helpful error messages when FTS not enabled
- Commit: c300013

### 2026-01-19: Implement search_books_by_tag_pattern tool (Phase 2)
- Created `src/tools/search-books-by-tag-pattern.ts`
- Finds all tags matching the pattern first
- Shows matching tags with book counts
- Returns books with any of the matching tags
- Useful for exploring related categories (e.g., 'fiction' finds Sci-Fi, Historical Fiction, etc.)
- Commit: 24d0222

### 2026-01-19: Implement get_books_by_tag tool (Phase 2)
- Created `src/tools/get-books-by-tag.ts`
- Exact tag matching by default, optional partial search
- Configurable sorting and result limit
- Returns title, authors, tags, series info, formats
- Commit: 3449318

### 2026-01-19: Document Missing Book Scout feature (PRD update)
- Added "Missing Book Scout" capability to @PRD.md feature inventory
- Describes ingesting a user-provided reading list, checking each title against Calibre, and when absent
  opening Anna's Archive search (e.g., https://annas-archive.pm/search?q=thanks+for+the+feedback)
- Mirrors backlog item under Phase 3 smart maintenance recipes

### 2026-01-19: Implement get_books_by_series tool (Phase 2)
- Created `src/tools/get-books-by-series.ts`
- Partial series name matching by default, optional exact match
- Sorted by series_index for correct reading order
- Returns title, authors, series_index, tags, formats
- Commit: 509f15a

### 2026-01-19: Implement get_books_by_author_id tool (Phase 2)
- Created `src/tools/get-books-by-author-id.ts`
- Looks up author name from ID via list_categories
- Performs exact author name match for precision
- Returns title, series, series_index, tags, pubdate, formats
- Useful when multiple authors have similar names
- Commit: b97d3b1

### 2026-01-19: Implement get_books_by_author tool (Phase 2)
- Created `src/tools/get-books-by-author.ts`
- Partial name matching by default, optional exact match
- Returns title, series, series_index, tags, pubdate, formats
- Configurable sorting (title, pubdate, series, rating) and limit
- Commit: 6579392

### 2026-01-19: Implement search_authors_by_name tool (Phase 2)
- Created `src/tools/search-authors-by-name.ts`
- Case-insensitive partial name matching
- Returns author ID and book count for each match
- Sort by name or count (default: most books first)
- Configurable result limit
- Commit: ba0a0f9

### 2026-01-19: Implement get_all_tags tool (Phase 2)
- Created `src/tools/get-all-tags.ts`
- Lists all tags with book counts
- Sort by name (alphabetical) or count (most used first)
- Optional minCount filter for tags with minimum books
- Formatted markdown output
- Commit: 0f43982

### 2026-01-19: Implement get_library_stats tool (Phase 2)
- Created `src/tools/get-library-stats.ts`
- Provides total counts: books, authors, tags, series, publishers
- Format breakdown (EPUB, PDF, etc.) with counts
- Top 10 authors and tags by book count
- Uses parallel data fetching via Promise.all for performance
- Commit: 2cd924b

### 2026-01-17: Implement search_books_by_title tool (Phase 2)
- Created `src/tools/search-books-by-title.ts`
- Tool accepts `title` pattern, `exact` (boolean), `limit`, `sortBy`, and `ascending` parameters
- Default mode performs wildcard/contains matching (e.g., "ring" finds "The Lord of the Rings")
- Optional exact match mode for precise title lookup
- Uses Calibre query language operators (~pattern for contains, =pattern for exact)
- Commit: 516477f

### 2026-01-17: Implement search_books tool (Phase 2)
- Created `src/tools/search-books.ts`
- Tool accepts `query` (Calibre query language), `limit`, `sortBy`, and `ascending` parameters
- Uses `calibredb list --search` to execute queries
- Supports field-specific searches (title:, author:, tag:, series:, etc.)
- Supports boolean operators (and, or, not)
- Returns id, title, authors, tags, series, and formats
- Commit: 05a807d

### 2026-01-17: Implement get_book_details tool (MVP)
- Created `src/tools/get-book-details.ts`
- Tool accepts a `bookId` parameter (positive integer)
- Uses `calibredb show_metadata <id>` to retrieve full metadata
- Returns title, authors, tags, formats, identifiers, publication info
- Marked as read-only and idempotent
- Commit: fd81e09

### 2026-01-17: Add prompts and resources
- Created `src/prompts/searchLibrary.ts` - Guided library search
- Created `src/prompts/libraryCleanup.ts` - Library hygiene helper
- Created `src/resources/libraryInfo.ts` - Library config resource
- Created `src/resources/customColumns.ts` - Custom columns resource

---

## Phase 1: MVP (Complete)

- [x] XMCP stdio transport configured (`xmcp.config.ts`)
- [x] Environment validation + calibredb runner (`src/config.ts`, `src/utils/calibredb.ts`)
- [x] `list_sample_books` - List representative titles
- [x] `get_book_details` - Show metadata for book ID
- [x] Documentation (CLAUDE.md, @PRD.md)
- [x] Resources: `calibre://library/info`, `calibre://library/custom-columns`
- [x] Prompts: `search_library`, `library_cleanup`

---

## Phase 2: Search & Discovery

### Core Search Tools
- [x] `searchBooks` - Generic Calibre query language search
- [x] `search_books_by_title` - Title wildcard search
- [x] `get_library_stats` - Library health dashboard (total counts, formats, tags summary)
- [x] `get_all_tags` - List all tags in library

### Author Discovery
- [x] `search_authors_by_name` - Find authors by name pattern
- [x] `get_books_by_author` - Get all books by author name
- [x] `get_books_by_author_id` - Get books by Calibre author ID

### Series Navigator
- [x] `get_books_by_series` - List books in a series with reading order

### Tag Explorer
- [x] `get_books_by_tag` - Get books with specific tag
- [x] `search_books_by_tag_pattern` - Wildcard tag search

### Full-Text Search
- [x] `fullTextSearch` - Calibre FTS integration
- [x] `fetch_excerpt` - Safe content peek (epub snippets)
- [x] Plain-text fallback for non-indexed content (`search_book_content`)

### Response Improvements
- [x] Structured JSON responses for all tools (`src/utils/response.ts`)
- [x] Friendly summaries alongside raw data (included in response utility)
- [x] Pagination for large result sets (`src/utils/pagination.ts`)

---

## Phase 3: Write Tools & Maintenance

### Custom Column Management
- [x] `getCustomColumns` - List custom column definitions
- [x] `setCustomColumn` - Update custom column value (with destructive annotation)

### Metadata Editing
- [x] `setMetadata` - Update book metadata fields (guarded)
- [x] Feature flag for enabling write operations (CALIBRE_ENABLE_WRITE_OPERATIONS)

### Cleanup & Duplicate Workbench
- [x] Duplicate detection helper (`find_duplicates`)
- [x] Metadata comparison tool (`compare_books`)
- [x] Guided merge/retag workflow (`merge_duplicates` prompt)
- [x] Book quality reports (`quality_report`)

### Smart Maintenance Recipes
- [x] Normalize author_sort bulk operation (`normalize_author_sort`)
- [x] Bulk retag by pattern (`bulk_retag`)
- [x] Schedule Calibre maintenance commands (`library_maintenance`)
- [x] Missing Book Scout (`missing_book_scout`) - check reading list against library, generate search links for missing

---

## Phase 4: Packaging & Deployment

### Platform UX
- [x] Auto-detect `calibredb` paths (Windows, macOs, linux support)
- [x] Claude Desktop config generator/helper (`generate_claude_config`)
- [x] MCP Inspector verification guide (`calibre://docs/inspector-guide` resource)
- [x] Docker recipe / Dockerfile
- [x] Improve MCP performance
- [x] Improve testing
- [x] Improve documentation

### Documentation
- [x] README.md with full setup instructions
- [x] Environment variable reference
- [x] Troubleshooting guide

---

## Phase 5: Codebase Improvements

Refactoring to reduce duplication, improve testability, and make adding new features easier.

### Utility Extractions (High Priority)
- [ ] Query helpers - `buildFieldQuery()`, `buildListArgs()` in `src/utils/query.ts`
- [ ] Book fetching utils - `getBookById<T>()`, `getBooksByIds<T>()` in `src/utils/books.ts`

### Utility Extractions (Medium Priority)
- [ ] ebook-convert wrapper - Extract `convertToText()` to `src/utils/ebook-convert.ts`
- [ ] Empty result handling - `formatNoResults()` in `src/utils/response.ts`
- [ ] Shared schema constants - `LIMITS`, `commonSchemas` in `src/utils/schema.ts`
- [ ] Category parsing - `parseCategories()`, `parseAuthorsFromCategories()`, `parseTagsFromCategories()`

### Testing Infrastructure
- [ ] Mock calibredb - `mockCalibredbOutput()`, `mockCalibredbError()` for isolated tool testing
- [ ] Test fixtures - Sample books, authors, tags data for consistent test scenarios
- [ ] Integration tests - End-to-end tests with mocked calibredb responses

### Code Quality
- [x] Enforce kebab-case filenames (renamed searchLibrary.ts, inspectorGuide.ts)
- [ ] Type-safe JSON parsing - Replace unsafe casts with validated parsers
- [ ] Consistent error handling - Standardized error formatting across all tools

---

## Open Questions (from PRD)

1. Do we need multilingual support for metadata/FTS results?
2. ~~Should we cache Calibre responses for repeated queries?~~ ✓ Implemented in Phase 4
3. What telemetry or logging is acceptable when running locally?
4. ~~How should we handle extremely large libraries (pagination strategies)?~~ ✓ Implemented in Phase 2
